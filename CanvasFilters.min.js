Filters={},"undefined"==typeof Float32Array?Filters.getFloat32Array=Filters.getUint8Array=function(len){return len.length?len.slice(0):new Array(len)}:(Filters.getFloat32Array=function(len){return new Float32Array(len)},Filters.getUint8Array=function(len){return new Uint8Array(len)}),"undefined"!=typeof document?(Filters.tmpCanvas=document.createElement("canvas"),Filters.tmpCtx=Filters.tmpCanvas.getContext("2d"),Filters.getPixels=function(img){var c,ctx;if(img.getContext){c=img;try{ctx=c.getContext("2d")}catch(e){}}return ctx||(ctx=(c=this.getCanvas(img.width,img.height)).getContext("2d")).drawImage(img,0,0),ctx.getImageData(0,0,c.width,c.height)},Filters.createImageData=function(w,h){return this.tmpCtx.createImageData(w,h)},Filters.getCanvas=function(w,h){var c=document.createElement("canvas");return c.width=w,c.height=h,c},Filters.filterImage=function(filter,image,var_args){for(var args=[this.getPixels(image)],i=2;i<arguments.length;i++)args.push(arguments[i]);return filter.apply(this,args)},Filters.toCanvas=function(pixels){var canvas=this.getCanvas(pixels.width,pixels.height);return canvas.getContext("2d").putImageData(pixels,0,0),canvas},Filters.toImageData=function(pixels){return this.identity(pixels)}):(onmessage=function(e){var ds=e.data;ds.length||(ds=[ds]),postMessage(Filters.runPipeline(ds))},Filters.createImageData=function(w,h){return{width:w,height:h,data:this.getFloat32Array(w*h*4)}}),Filters.runPipeline=function(ds){var res=null;res=this[ds[0].name].apply(this,ds[0].args);for(var i=1;i<ds.length;i++){var d=ds[i],args=d.args.slice(0);args.unshift(res),res=this[d.name].apply(this,args)}return res},Filters.createImageDataFloat32=function(w,h){return{width:w,height:h,data:this.getFloat32Array(w*h*4)}},Filters.identity=function(pixels,args){for(var output=Filters.createImageData(pixels.width,pixels.height),dst=output.data,d=pixels.data,i=0;i<d.length;i++)dst[i]=d[i];return output},Filters.grayscale=function(pixels,args){for(var output=Filters.createImageData(pixels.width,pixels.height),dst=output.data,d=pixels.data,i=0;i<d.length;i+=4){var r,g,b,v=.3*d[i]+.59*d[i+1]+.11*d[i+2];dst[i]=dst[i+1]=dst[i+2]=v,dst[i+3]=d[i+3]}return output},Filters.brightnessContrast=function(pixels,brightness,contrast){var lut=this.brightnessContrastLUT(brightness,contrast);return this.applyLUT(pixels,{r:lut,g:lut,b:lut,a:this.identityLUT()})},Filters.applyLUT=function(pixels,lut){for(var output=Filters.createImageData(pixels.width,pixels.height),d=pixels.data,dst=output.data,r=lut.r,g=lut.g,b=lut.b,a=lut.a,i=0;i<d.length;i+=4)dst[i]=r[d[i]],dst[i+1]=g[d[i+1]],dst[i+2]=b[d[i+2]],dst[i+3]=a[d[i+3]];return output},Filters.createLUTFromCurve=function(points){for(var lut=this.getUint8Array(256),p=[0,0],i=0,j=0;i<lut.length;i++){for(;j<points.length&&points[j][0]<i;)p=points[j],j++;lut[i]=p[1]}return lut},Filters.identityLUT=function(){for(var lut=this.getUint8Array(256),i=0;i<lut.length;i++)lut[i]=i;return lut},Filters.invertLUT=function(){for(var lut=this.getUint8Array(256),i=0;i<lut.length;i++)lut[i]=255-i;return lut},Filters.brightnessContrastLUT=function(brightness,contrast){for(var lut=this.getUint8Array(256),contrastAdjust,brightnessAdjust,adjust=-128*contrast+128+255*brightness,i=0;i<lut.length;i++){var c=i*contrast+adjust;lut[i]=c<0?0:c>255?255:c}return lut};